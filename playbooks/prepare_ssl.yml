---
- name: Create SSL key
  gather_facts: False
  hosts: localhost
  vars_files:
  - vars/guests.yml
  tasks:
  - name: Add bastion to dynamic host
    add_host:
      name: bastion
      group: bast
  - name: Add other hosts to nodes group
    add_host:
      name: "{{item.name}}"
      group: nodes
    when: item.name != 'bastion'
    with_items: "{{guests}}"
  - name: Create SSH key for root
    user:
      name: root
      generate_ssh_key: yes
      ssh_key_bits: 2048
      ssh_key_file: .ssh/id_rsa

- name: Prepare host and guests
  gather_facts: False
  hosts: all
  vars_files:
  - vars/guests.yml
  tasks:
  - name: Remove old known_hosts
    file:
      path: /root/.ssh/known_hosts
      state: absent
  - name: Add key to authorized_keys
    authorized_key:
      user: root
      state: present
      key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"
  - name: Run ssh-keyscan to add keys to known_hosts
    local_action: shell ssh-keyscan {{ inventory_hostname }} >> ~/.ssh/known_hosts
  - name: Copy etc hosts file to all hosts
    copy:
      src: /etc/hosts
      dest: /etc/hosts
