---
- name: Prepare public key auth
  gather_facts: False
  hosts: all
  become: true
  tasks:
  - name: Remove old known_hosts
    local_action:
      shell rm -Rf "{{user_ssh_dir}}/known_hosts"
  - name: Add key to authorized_keys
    authorized_key:
      user: "{{remote_user}}"
      state: present
      key: "{{ lookup('file', user_ssh_dir+'/id_rsa.pub') }}"
  - name: Run ssh-keyscan to add keys to known_hosts
    local_action: shell ssh-keyscan {{ inventory_hostname }} >> {{user_ssh_dir}}/known_hosts

- name: Copy etc/hosts to all guests
  hosts: all
  become: true
  tasks:
  - name: Copy etc hosts file to all hosts
    copy:
      src: /etc/hosts
      dest: /etc/hosts
