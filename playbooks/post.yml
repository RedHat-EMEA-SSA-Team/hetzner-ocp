---
- name: Create password for cluster admin
  hosts: master01
  gather_facts: false
  vars_prompt:
  - name: admin_pwd
    prompt: Admin password
    private: true
  vars_files:
  - vars/guests.yml
  tasks:
  - name: Add bastion to dynamic host
    add_host:
      name: bastion
      group: bast
      ansible_ssh_user: cloud-user
  - name: Add other hosts to nodes group
    add_host:
      name: "{{item.name}}"
      group: nodes
      ansible_ssh_user: cloud-user
    when: item.name != 'bastion'
    with_items: "{{guests}}"
  - name: Add user
    command: "htpasswd -b /etc/origin/master/htpasswd admin {{admin_pwd}}"
  - name: Add privileges
    command: "oc adm policy add-cluster-role-to-user cluster-admin admin"
- name: Fix all kind of stuff
  hosts: nodes
  gather_facts: false
  tasks:
  - name: Fix bug with DNS
    lineinfile:
      dest: /etc/resolv.conf
      state: present
      insertafter: '# Generated by NetworkManager'
      line: 'search cluster.local'
- name: Create hostpath stuff for registry
  hosts: localhost
  gather_facts: false
  tasks:
  - name: Create raw image
    command: "qemu-img create -f raw /var/lib/libvirt/images/docker-registry.img 100G"
  - name: Add new disk to node01 as vdc
    command: virsh attach-disk infranode01 --source /var/lib/libvirt/images/docker-registry.img --persistent --target vdc
- name: Prepare infranode for hostpath
  hosts: infranode01
  tasks:
  - name: Makefs
    command: mkfs.ext4 /dev/vdc
  - name: Mount new disk to mount point
    lineinfile:
      path: /etc/fstab
      state: present
      line: "/dev/vdc  /var/hostpath/registry  ext4    defaults    0 0"
  - name: Refresh mounts
    command: mount -a
  - name: Create mount point
    file:
      path: "/var/hostpath/registry"
      state: directory
      owner: nfsnobody
      group: nfsnobody
      mode: 0777
  - name: SELinux svirt_sandbox_file_t
    command: "chcon -Rt svirt_sandbox_file_t /var/hostpath/registry"
- name: Add hostpath volumen to registry
  hosts: master01
  tasks:
  - name: Add scc hostaccess
    command: "oc adm policy add-scc-to-user hostaccess -z registry"
  - name: Add volumen to regisry dc
    command: "oc volume dc/docker-registry --add -t hostPath --path /var/hostpath/registry -m /registry --name registry-storage --overwrite"
- name: All done, ready to rock
  hosts: localhost
  gather_facts: true
  tasks:
  - name: All done, you can now login
    debug:
      msg:
      - "Login to Openshift:"
      - "oc login -u admin https://master.{{hostvars['localhost']['ansible_default_ipv4']['address']}}.xip.io:8443"
